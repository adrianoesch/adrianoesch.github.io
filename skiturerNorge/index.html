<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skiturer i Norge</title>
  <!-- main libs -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!-- leaflet search plugin-->
  <script src="./libs/leaflet-search/js/leaflet-gplaces-autocomplete.js"></script>
  <link rel="stylesheet" href="./libs/leaflet-search/css/leaflet-gplaces-autocomplete.css" />
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBQT5f94LsmFh2O4dn_HlQe0pQQMoUWUmM&libraries=places"></script>
  <!-- leaflet gps plugin -->
  <link rel="stylesheet" href="./libs/leaflet-gps/leaflet-gps.min.css" />
  <script src="./libs/leaflet-gps/leaflet-gps.min.js"></script>
  <!-- vector grid -->
  <script type="text/javascript"  src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>

  <!-- leaflet offline plugin -->
  <!-- <script src="./libs/leaflet.offline.min.js"></script> -->
  <!-- <link rel="stylesheet" href="/libs/leaflet.css" /> -->
  <!-- <script src="./libs/leaflet.js"></script> -->
  <!-- <script src="./libs/jquery.min.js"></script> -->
  <link rel="stylesheet" type="text/css" href='style.css'></link>
</head>
<style>
div{
  font-family: 'helvetica';
}
#title{
  margin-top: 2%;
}
#title h1{
  margin-bottom: 2px;
  margin-top: 0px;
  font-size: 160%;
}
#title p{
  margin-top: 0px;
  margin-bottom: 0px;
}
#header{
  position: absolute;
  padding: 15px;
  z-index: 10;
  max-width: 70%;
  width: 380px;
  height: auto;
  float: left;
  background: rgba(255,255,255,0);
  color: rgba(45, 71, 147,0);
  transition: 0.5s;
  border-radius: 12px;
}
#header:hover{
  background: rgba(255,255,255,0.5);
  color: rgba(45, 71, 147,1);
}
#logo{
  position: relative;
  z-index: 11;
  float:left;
  margin-right: 5%;
}
</style>
<body>
  <div id='header'>
    <svg id="logo">
      <defs>
        <linearGradient id="grad1" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:rgb(219, 230, 255);stop-opacity:1" />
          <stop offset="100%" style="stop-color:rgb(20, 64, 193);stop-opacity:1" />
        </linearGradient>
      </defs>
      <polygon id="logoPoly" points="" style="fill:url(#grad1);" />
    </svg>
    <div id='title'>
      <h1>Skiturer i Norge</h1>
      <p>en rute aggregator</p>
    </div>
  </div>
  <div class='left map' id='mapid'></div>
</body>
<script>
// helper functions
function turPopup(tur){
    return("<div><a target='_bank' href='"+tur.href+"'>"+tur.name+"</a></div>")
};

function hyttaPopup(tur){
    return("<div><a target='_bank' href='"+tur.href+"'>"+tur.name+" ("+tur.type+")</a></div>")
};

function addTur(tur){
  L.polyline( tur.points, {
    weight:2,
    color:'rgb(0, 140, 255)',
  }).bindPopup(turPopup(tur)).on('mouseover', function (e) {
    e.target.setStyle({
      weight:4,
      color:'rgb(2, 119, 215)',
    });
  }).on('mouseout', function (e) {
    e.target.setStyle({
      weight:2,
      color:'rgb(0, 140, 255)',
    })
  }).addTo(map)
};

function addHytta(hytta){
    L.marker( hytta.points,{
      weight:3,
      color:'rgb(162, 0, 0)'
    }).bindPopup(hyttaPopup(hytta)).addTo(map)
}

// display icon
var win10p = screen.width*(15/100)
var logoWidth = Math.min(win10p, 100)
var logoHeight = logoWidth * Math.sqrt(3) / 2
var points = "0,"+logoHeight.toString()+" "+(logoWidth/2.0).toString()+",0 "+logoWidth.toString()+","+logoHeight.toString();
document.getElementById('logoPoly').setAttribute("points",points)
document.getElementById('logo').setAttribute('height',logoHeight.toString())
document.getElementById('logo').setAttribute('width',logoWidth.toString())

// change defaults
var oldOptions = L.Icon.Default.prototype.options
L.Icon.Default.prototype.options.iconSize = [oldOptions.iconSize[0]/2.0 ,oldOptions.iconSize[1]/2.0] ;
L.Icon.Default.prototype.options.iconAnchor = [oldOptions.iconAnchor[0]/2.0 ,oldOptions.iconAnchor[1]/2.0] ;
L.Icon.Default.prototype.options.shadowSize = [0,0] ;

// init map
var map = L.map('mapid',{'zoomControl':false})
var zoom = L.control.zoom({'position':'bottomright'}).addTo(map)
var scale = L.control.scale({'imperial':false}).addTo(map)

// tiles
var baseLayer = L.tileLayer('https://opencache.statkart.no/gatekeeper/gk/gk.open_gmaps?layers=topo4&zoom={z}&x={x}&y={y}',{
  doubleClickZoom: false,
  attribution:'<a href="https://www.kartverket.no">Kartverket</a>',
  attributionPosition: 'bottomleft'
}).addTo(map);

var bratthet = L.tileLayer.wms('https://gis3.nve.no/map/services/Bratthet/MapServer/WmsServer?',{
  position:'bottomleft',
  attribution:'<a href="https://www.nve.no">NVE</a>',
  layers: 'Bratthet_snoskred',
  transparent: true,
  format:'png',
  opacity:0.5
}).addTo(map);


// search
new L.Control.GPlaceAutocomplete({
          callback: function(place){
              console.log(place)
              var loc = place.geometry.location;
              map.setView([loc.lat(), loc.lng()],14);
          },
          collapsed_mode:true
      }).addTo(map);

// gps
map.addControl( new L.Control.Gps({
  position:'topright',
  autoCenter:true
}) );

// load data
$.ajax({
  url:'./ut_data.json',
  method:'get',
  success:function(data){
    // var turerGeoJson = {
    //     "type": "FeatureCollection",
    //     "features": data['turer'].map(function(i){
    //        var feature = {
    //          'type' : 'Feature',
    //          'geometry': {
    //            'type':'LineString',
    //            'coordinates': i['points']
    //          },
    //          'properties':{
    //            'name': i['name']
    //          }
    //       };
    //     return(feature)
    //   })
    // };
    // L.vectorGrid.slicer(turerGeoJson,{}).addTo(map)
    data['turer'].map(addTur)
    data['hytter'].map(addHytta)
  }
})

// set location
if (navigator.geolocation) {
  map.setView([62.5942, 9.6912], 10);
  navigator.geolocation.getCurrentPosition(function(position){
    map.setView([position.coords.latitude, position.coords.longitude], 10);
  });
} else {
  map.setView([62.5942, 9.6912], 10);
}

// roadmap:
// - offline feature
// - more tracks/sources
// - vector grid paths
</script>
</html>
